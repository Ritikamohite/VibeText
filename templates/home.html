{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<!-- Messages Display -->
{% if messages %}
<div class="messages-container">
  {% for message in messages %}
  <div class="message-alert {% if message.tags %}{{ message.tags }}{% endif %}">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="app-shell">
{% include 'partials/sidebar.html' %}
  
<!-- ================= MAIN CONTENT ================= -->
<main class="main">

    <!-- COMPOSER -->
    {% if request.user.is_authenticated %}
    <section class="composer-card">
      {% if profile and profile.photo %}
        <div class="avatar"><img src="{{ profile.photo.url }}{% if profile.photo.name %}?v={{ profile.photo.name }}{% endif %}" alt="{{ request.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" /></div>
      {% else %}
        <div class="avatar">{{ request.user.username|first|upper }}</div>
      {% endif %}

    <form method="POST" action="{% url 'create_post' %}" class="composer-main">
      {% csrf_token %}
    <div class="textarea-wrapper">
      <textarea id="postText"
          name="content"
          rows="3"
          placeholder="What's happening?"
          required
          spellcheck="true"
          autocorrect="on"
          autocomplete="on"
          autocapitalize="sentences"></textarea>

          <button
          type="button"
          id="mic-btn"
          class="mic-btn"
          title="Speak"
          aria-label="Speech to text"
        >
          üé§
        </button>
    </div>
        


      <div class="composer-footer">
        <div class="composer-actions">
            <button type="submit" name="action" value="publish" class="primary-btn">Post</button>
            <!-- save draft (submit) -->
            <button type="submit" name="action" value="draft" class="icon-btn" title="Save draft" aria-label="Save draft">
              <!-- pencil icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#e5e7eb"/></svg>
            </button>
            <!-- drafts link merged into icon (folder glyph to differentiate) -->
            <a href="{% url 'drafts' %}" class="icon-btn" title="Drafts" aria-label="Drafts">
              <!-- folder icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 4H2v16h20V6H12l-2-2z" fill="#e5e7eb"/></svg>
            </a>
          </div>
      </div>
    </form>
  </section>
  {% else %}
  <section class="composer-card guest">
    <div style="padding:1rem">
      <p><strong>Welcome!</strong> <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'register' %}">create an account</a> to post and interact.</p>
    </div>
  </section>
  {% endif %}

    <!-- ================= POSTS ================= -->
  <section class="posts-list">
    {% for post in posts %}
<article class="post" id="post-{{ post.id }}">


        <div class="avatar">
          {% with up=post.user.profile %}
            {% if up and up.photo %}
              <img src="{{ up.photo.url }}{% if up.photo.name %}?v={{ up.photo.name }}{% endif %}" alt="{{ post.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
            {% else %}
              {{ post.user.username|first|upper }}
            {% endif %}
          {% endwith %}
        </div>
      

      <div class="post-main">
        <header class="post-header">
          <a href="{% url 'profile' post.user.username %}" class="post-author-link">
            @{{ post.user.username }}
          </a>
          <span class="post-dot">¬∑</span>
          <span class="post-time">{{ post.created_at|timesince }} ago</span>
        </header>

          <p class="post-body">{{ post.content|urlize|linebreaksbr }}</p>
          <footer class="post-footer">
            <div class="post-actions">
              <div class="like-section">
                  {% if post.is_community %}
                    <span class="action-btn">
                      <span class="action-icon">ü§ç</span>
                      <span class="action-count">{{ post.like_count }}</span>
                    </span>
                  {% else %}
                    {% if request.user.is_authenticated %}
                      {% if post.id in liked_posts %}
                      <a href="{% url 'unlike' post.id %}#post-{{ post.id }}" class="action-btn liked">
                        <span class="action-icon">‚ù§Ô∏è</span>
                          <span class="action-count">{{ post.like_count }}</span>
                        </a>
                      {% else %}
                        <a href="{% url 'like' post.id %}" class="action-btn">
                          <span class="action-icon">ü§ç</span>
                          <span class="action-count">{{ post.like_count }}</span>
                        </a>
                      {% endif %}
                    {% else %}
                      <a href="{% url 'login' %}?next={{ request.path }}" class="action-btn" title="Log in to like">
                        <span class="action-icon">ü§ç</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% endif %}
                  {% endif %}

                  <button
                  type="button"
                  class="action-btn comment-btn"
                  onclick="toggleComments('{{ post.id }}')"
                >
                  üí¨ <span>{{ post.comments.count }}</span>
                </button>
                

              </div>
              {% if request.user.is_authenticated and request.user == post.user %}
                <div class="post-owner-actions">
                  <a href="{% url 'edit_post' post.id %}" class="action-btn" title="Edit">‚úèÔ∏è</a>
                  <button type="button" class="action-btn delete-btn" data-delete-url="{% url 'delete_post' post.id %}" data-post-content="{{ post.content|escapejs }}" title="Delete">üóëÔ∏è</button>
                </div>
              {% endif %}
              
            </div>
          </footer>

               <!-- Comments -->
               <section
               class="comments-wrapper"
               id="comments-{{ post.id }}"
             >
             
        {% for comment in post.comments.all %}
        {% if True %}
        <div class="yt-comment">
        
            <!-- Avatar -->
            
            <!-- Comment Body -->
            <div class="yt-body">
        
              <div class="yt-header">
                <span class="yt-username">@{{ comment.user.username }}</span>
                <span class="yt-time">{{ comment.created_at|timesince }} ago</span>
              </div>
        
              <div class="yt-text" id="comment-text-{{ comment.id }}">
                {{ comment.text }}
              </div>
        
              <!-- Actions -->
               <div class="yt-actions">
                <button onclick="toggleReply('{{ comment.id }}')">Reply</button>

                {% if request.user.is_authenticated %}
                  <a href="{% url 'toggle_comment_like' comment.id %}" class="comment-like-btn">
                    {% if comment.id in liked_comments %} ‚ù§Ô∏è {% else %} ü§ç {% endif %} {{ comment.likes.count }}
                  </a>
                {% else %}
                  <a href="{% url 'login' %}?next={{ request.path }}" class="comment-like-btn" title="Log in to like">
                    {% if comment.id in liked_comments %} ‚ù§Ô∏è {% else %} ü§ç {% endif %} {{ comment.likes.count }}
                  </a>
                {% endif %}

                {% if user == comment.user %}

                <!-- Edit -->
                <button type="button" onclick="toggleEdit('{{ comment.id }}')">
                  Edit
                </button>
              
                <!-- Delete -->
                <form method="POST"
                action="{% url 'delete_comment' comment.id %}#post-{{ post.id }}"
                style="display:inline;">
          
                  {% csrf_token %}
                  <button type="submit" class="danger">
                    Delete
                  </button>
                </form>
              
              {% endif %}
              
                 </div>

              <!-- Edit form -->
              {% if user == comment.user %}
              <form method="POST"
      action="{% url 'edit_comment' comment.id %}#post-{{ post.id }}"
      id="edit-form-{{ comment.id }}"
      class="yt-edit-form"
      style="display:none;">

                {% csrf_token %}
                <input type="text"
                name="text"
                value="{{ comment.text }}"
                spellcheck="true"
                autocorrect="on"
                autocapitalize="sentences">
                         <button type="submit">Save</button>
              </form>
              {% endif %}
        
              <!-- Reply form -->
              <form method="POST"
      action="{% url 'reply_comment' comment.id %}#post-{{ post.id }}"
      id="reply-form-{{ comment.id }}"
      class="yt-reply-form"
      style="display:none;">

                {% csrf_token %}
                <input type="text"
                name="text"
                placeholder="Add a reply‚Ä¶"
                spellcheck="true"
                autocorrect="on"
                autocapitalize="sentences">
                         <button type="submit">Reply</button>
              </form>
        
              <!-- Replies toggle -->
              {% if comment.replies.count %}
              <button type="button"
              class="yt-view-replies"
              id="toggle-btn-{{ comment.id }}"
              data-count="{{ comment.replies.count }}"
              onclick="toggleReplies('{{ comment.id }}')">
              View {{ comment.replies.count }} replies ‚ñº
              </button>
      
      
              {% endif %}
        
              <!-- Replies -->
              <div class="yt-replies" id="replies-{{ comment.id }}" style="display:none;">
                {% for reply in comment.replies.all %}
                <div class="yt-reply">
        
                  <div class="yt-avatar small">
                    {{ reply.user.username|first|upper }}
                  </div>
        
                  <div class="yt-body">
                    <span class="yt-username">@{{ reply.user.username }}</span>
                    <p>{{ reply.text }}</p>
                  </div>
        
                </div>
                {% endfor %}
              </div>
        
            </div>
          </div>
          {% endif %}
        {% endfor %}
        
        <!-- New Comment -->
        {% if request.user.is_authenticated %}
        <form method="POST"
        action="{% url 'add_comment' post.id %}#post-{{ post.id }}"
        class="yt-new-comment">
            {% csrf_token %}
            <input type="text"
            name="comment"
            placeholder="Add a comment‚Ä¶"
            required
            spellcheck="true"
            autocorrect="on"
            autocapitalize="sentences">
               <button type="submit">Send</button>
        </form>
        {% else %}
        <div class="yt-new-comment guest">
          <a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to comment.
        </div>
        {% endif %}
        
        </section>

    
        


      </div>
    </article>
    {% empty %}
     <p>No posts yet.</p>
    {% endfor %}
  </section>



</main>

<aside class="right-sidebar">
  <section class="trending-section">
    <h3>Trending</h3>
    <div class="hashtag-list">
      {% for tag in trending_hashtags %}
        <a href="{% url 'search' %}?q=%23{{ tag }}" class="hashtag-chip">#{{ tag }}</a>
      {% empty %}
        <p>No trending tags yet</p>
      {% endfor %}
    </div>

    <h4>Top posts</h4>
    <div class="trending-posts">
      {% for tpost in trending_posts %}
        <div class="tpost-row">
          <div class="avatar">{{ tpost.user.username|first|upper }}</div>
          <div class="tpost-main">
            <a href="{% url 'profile' tpost.user.username %}"><strong>{{ tpost.user.username }}</strong></a>
            <a href="{% url 'post_detail' tpost.id %}" class="tpost-link"><p class="tpost-snippet">{{ tpost.content|truncatechars:60 }}</p></a>
          </div>
        </div>
      {% empty %}
        <p>No trending posts yet</p>
      {% endfor %}
    </div>
  </section>
</aside>



</div>


<script>
  function toggleReply(id) {
      const f = document.getElementById(`reply-form-${id}`);
      f.style.display = f.style.display === "block" ? "none" : "block";
  }
  
  function toggleEdit(id) {
      document.getElementById(`edit-form-${id}`).style.display = "block";
      document.getElementById(`comment-text-${id}`).style.display = "none";
  }
  
  function toggleReplies(id) {
      const replies = document.getElementById(`replies-${id}`);
      const btn = document.getElementById(`toggle-btn-${id}`);
  
      if (!replies || !btn) return;
  
      const count = btn.getAttribute("data-count");
  
      if (replies.style.display === "none" || replies.style.display === "") {
          replies.style.display = "block";
          btn.innerText = "Hide replies ‚ñ≤";
      } else {
          replies.style.display = "none";
          btn.innerText = `View ${count} replies ‚ñº`;
      }
  }
  </script>

<script>
  (function () {
    const fixes = {
      "im": "I'm",
      "dont": "don't",
      "cant": "can't",
      "u": "you",
      "ur": "your",
      "pls": "please"
    };
  
    function autoFix(input) {
      let words = input.value.split(/\b/);
      words = words.map(w => fixes[w.toLowerCase()] || w);
      input.value = words.join("");
    }
  
    document.addEventListener("blur", function (e) {
      if (e.target.matches("textarea, input[type='text']")) {
        autoFix(e.target);
      }
    }, true);
  })();
  </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  
    const micBtn = document.getElementById("mic-btn");
    const textarea = document.querySelector("textarea");
  
    if (!micBtn || !textarea) {
      console.error("Mic button or textarea not found");
      return;
    }
  
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
  
    if (!SpeechRecognition) {
      alert("Speech Recognition not supported in this browser");
      return;
    }
  
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;
  
    let isListening = false;
  
    recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      textarea.value += (textarea.value ? " " : "") + text;
    };
  
    recognition.onerror = (event) => {
      alert("Mic error: " + event.error);
    };
  
    recognition.onend = () => {
      isListening = false;
      micBtn.classList.remove("listening");
    };
  
    micBtn.addEventListener("click", () => {
      if (isListening) {
        recognition.stop();
        return;
      }
  
      recognition.start();
      isListening = true;
      micBtn.classList.add("listening");
    });
  
  });
  </script>
  

<script>
 function toggleComments(postId) {
  const comments = document.getElementById(`comments-${postId}`);
  if (!comments) return;

  comments.classList.toggle("open");
}

</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // If page reloaded after comment submission
    if (window.location.hash.startsWith("#post-")) {
      const postId = window.location.hash.replace("#post-", "");
      const comments = document.getElementById(`comments-${postId}`);
      if (comments) {
        comments.classList.add("open");
      }
    }
  });
  </script>

  <style>
    /* Make like + comment inline */
.like-section {
  display: flex;
  align-items: center;
  gap: 1.2rem;
}

/* Keep buttons consistent */
.like-section .action-btn {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

/* Optional: nicer hover */
.like-section .action-btn:hover {
  opacity: 0.85;
}

  </style>
  

{% endblock %}




